name: ğŸŒ™ Nightly Analytics Snapshot (Hybrid+X Intelligence Layer v2)

on:
  schedule:
    - cron: "0 2 * * *"   # ğŸ•‘ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 02:00 UTC
  workflow_dispatch:

jobs:
  nightly-snapshot:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ”§ Install dependencies
        run: |
          pip install requests pyyaml

      - name: ğŸ§  Generate daily analytics snapshot from Hybrid Feedback
        env:
          HYBRID_FEEDBACK_ENDPOINT: ${{ secrets.HYBRID_FEEDBACK_ENDPOINT }}
          HYBRID_TOKEN: ${{ secrets.HYBRID_API_TOKEN }}
        run: |
          python - <<'PYCODE'
import os, json, requests
from datetime import datetime
from pathlib import Path

# === Paths ===
analytics_dir = Path("docs/analytics")
analytics_dir.mkdir(exist_ok=True)

# === Config ===
endpoint = os.getenv("HYBRID_FEEDBACK_ENDPOINT", "http://localhost:9090/api/v1/hybrid/feedback")
token = os.getenv("HYBRID_TOKEN", "mock-token")
headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}

now = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
date_file = datetime.utcnow().strftime("%Y-%m-%d")
snapshot_path = analytics_dir / f"{date_file}.md"

print(f"ğŸŒ Fetching Hybrid feedback from {endpoint}...")

try:
    response = requests.get(endpoint, headers=headers, timeout=10)
    response.raise_for_status()
    feedback = response.json()
except Exception as e:
    print(f"âŒ Failed to get feedback from Hybrid: {e}")
    raise SystemExit(1)

# === Extract and calculate ===
labs = feedback.get("labs", [])
summary = feedback.get("summary", {})

trust_index = summary.get("overall_trust_index", 0.0)
total_labs = summary.get("total_labs", len(labs))
eligible = summary.get("eligible_for_promotion", 0)
avg_risk = sum(l.get("risk_score", 0) for l in labs) / total_labs if total_labs else 0.0
security_trust_index = round(trust_index * (1 - avg_risk), 3)

# === Snapshot ===
content = f"""# ğŸ§¾ WebKurierX â€” Daily Analytics Snapshot
**Date:** {date_file}  
**Generated:** {now} UTC  

**Trust Index:** {trust_index:.3f}  
**Risk Index:** {avg_risk:.3f}  
**Security Trust Index (STI):** {security_trust_index:.3f}  
**Total Labs:** {total_labs}  
**Eligible for Promotion:** {eligible}

---

### ğŸ§© Labs Overview
| Lab | Trust | Risk | Promotion Ready |
|:----|:------:|:----:|:----------------:|
"""

for lab in labs:
    content += f"| {lab.get('name')} | {lab.get('trust_score', 0):.3f} | {lab.get('risk_score', 0):.3f} | {'âœ…' if lab.get('promotion_ready') else 'âŒ'} |\n"

content += f"""

---

### ğŸ§  Summary
- Source: **Hybrid Feedback API**
- Endpoint: `{endpoint}`
- Data retrieved successfully at: {now} UTC
- Snapshot automatically generated by *Hybrid+X Nightly Analytics workflow*.
"""

with open(snapshot_path, "w", encoding="utf-8") as f:
    f.write(content)

print(f"âœ… Snapshot saved: {snapshot_path}")
PYCODE

      - name: ğŸ“Š Update analytics index
        run: python scripts/build_analytics_index.py

      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --global user.name "WebKurierX Bot"
          git config --global user.email "bot@webkurier.ai"
          git add docs/analytics/
          git commit -m "ğŸŒ™ Nightly analytics snapshot + index update [Hybrid-linked]" || echo "No changes"
          git push

