import os
import requests
import datetime
import pathlib
import json

# ğŸ§© ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
endpoint = os.getenv("HYBRID_FEEDBACK_ENDPOINT", "http://localhost:9090/api/v1/hybrid/feedback")
token = os.getenv("HYBRID_TOKEN", "mock-token")
headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}

# ğŸ—‚ ĞŸÑƒÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¸ Markdown
docs_path = pathlib.Path("docs/FEEDBACK_STATUS.md")
logs_dir = pathlib.Path("logs")
logs_dir.mkdir(parents=True, exist_ok=True)
log_file = logs_dir / "hybrid_feedback.log"

print(f"ğŸŒ Fetching feedback from Hybrid endpoint: {endpoint}")

# ğŸ›° ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚ Hybrid API
try:
    response = requests.get(endpoint, headers=headers, timeout=10)
    response.raise_for_status()
    data = response.json()
except Exception as e:
    print(f"âŒ Failed to get feedback: {e}")
    with log_file.open("a", encoding="utf-8") as lf:
        lf.write(f"[{datetime.datetime.utcnow()}] ERROR: {e}\n")
    raise SystemExit(1)

timestamp = datetime.datetime.utcnow().isoformat() + "Z"
labs = data.get("labs", [])
summary = data.get("summary", {})

# ğŸ§¾ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ»Ğ¾Ğ³
with log_file.open("a", encoding="utf-8") as lf:
    lf.write(f"\n[{timestamp}] Feedback sync\n")
    for lab in labs:
        lf.write(
            f"  - {lab.get('name')}: trust={lab.get('trust_score', 0):.2f}, "
            f"status={lab.get('status')}, ready={lab.get('promotion_ready')}\n"
        )
    lf.write(
        f"  Summary: overall_trust={summary.get('overall_trust_index', 0):.2f}, "
        f"eligible={summary.get('eligible_for_promotion', 0)} / "
        f"total={summary.get('total_labs', len(labs))}\n"
    )

print(f"ğŸªµ Feedback log updated â†’ {log_file}")

# ğŸ“Š Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Markdown
table_header = "| ğŸ§ª Lab | ğŸ”’ Trust Score | ğŸ“Š Status | ğŸš€ Promotion Ready | ğŸ“ Notes |\n"
table_header += "|:------|:---------------:|:----------|:------------------:|:---------|\n"

rows = []
for lab in labs:
    rows.append(
        f"| {lab.get('name')} "
        f"| {lab.get('trust_score', 0):.2f} "
        f"| {'âœ… validated' if lab.get('status') == 'validated' else 'ğŸ•“ ' + lab.get('status', 'unknown')} "
        f"| {'âœ… yes' if lab.get('promotion_ready') else 'âŒ no'} "
        f"| {lab.get('notes', '').replace('|', '/')} |"
    )
table = "\n".join(rows)

summary_table = (
    "| Metric | Value |\n"
    "|:--------|:------|\n"
    f"| Total Labs | {summary.get('total_labs', len(labs))} |\n"
    f"| Eligible for Promotion | {summary.get('eligible_for_promotion', 0)} |\n"
    f"| Overall Trust Index | {summary.get('overall_trust_index', 0):.2f} |\n"
)

# ğŸ§± Markdown ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
content = f"""# ğŸ” Hybrid Feedback Status

_Last sync: **{timestamp} UTC**_

---

## ğŸ§  Overview

This dashboard is automatically generated by  
`Hybrid Feedback Listener (v1)` â€” synchronizing lab trust and promotion readiness from Hybrid.

| Field | Description |
|:------|:-------------|
| `trust_score` | Numerical trust index (0â€“1.0) |
| `status` | Lab security validation stage |
| `promotion_ready` | Indicates if lab can move up from sandbox |
| `notes` | Short summary of Hybrid feedback pipeline |

---

## ğŸ§© Latest Feedback Snapshot

{table_header}{table}

---

## ğŸ“ˆ Summary

{summary_table}

---

### ğŸ§¾ Historical Log Reference
The full feedback history is available in:  
`logs/hybrid_feedback.log`

---

### ğŸ§© Next Update
Synced every **15 minutes** or via manual trigger  
**Actions â†’ ğŸ” Hybrid Feedback Listener (v1)**

_Last updated automatically by `scripts/pull_hybrid_feedback.py`_
"""

# ğŸ“ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Markdown
docs_path.write_text(content, encoding="utf-8")
print(f"âœ… Markdown dashboard updated â†’ {docs_path}")
