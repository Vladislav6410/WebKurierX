import os
import requests
import datetime
import pathlib
import json

# ğŸ§© ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
endpoint = os.getenv("HYBRID_FEEDBACK_ENDPOINT", "http://localhost:9090/api/v1/hybrid/feedback")
token = os.getenv("HYBRID_TOKEN", "mock-token")
headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}

print(f"ğŸŒ Fetching feedback from Hybrid endpoint: {endpoint}")

# ğŸ›° ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚ Hybrid
try:
    response = requests.get(endpoint, headers=headers, timeout=10)
    response.raise_for_status()
    data = response.json()
except Exception as e:
    print(f"âŒ Failed to get feedback: {e}")
    raise SystemExit(1)

timestamp = datetime.datetime.utcnow().isoformat() + "Z"
labs = data.get("labs", [])
summary = data.get("summary", {})

# ğŸ“Š Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ»Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
table_header = "| ğŸ§ª Lab | ğŸ”’ Trust Score | ğŸ“Š Status | ğŸš€ Promotion Ready | ğŸ“ Notes |\n"
table_header += "|:------|:---------------:|:----------|:------------------:|:---------|\n"

rows = []
for lab in labs:
    rows.append(
        f"| {lab.get('name')} "
        f"| {lab.get('trust_score', 0):.2f} "
        f"| {'âœ…' if lab.get('status') == 'validated' else 'ğŸ•“ ' + lab.get('status', 'unknown')} "
        f"| {'âœ… yes' if lab.get('promotion_ready') else 'âŒ no'} "
        f"| {lab.get('notes', '')} |"
    )
table = "\n".join(rows)

# ğŸ“ˆ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Summary
summary_table = (
    "| Metric | Value |\n"
    "|:--------|:------|\n"
    f"| Total Labs | {summary.get('total_labs', len(labs))} |\n"
    f"| Eligible for Promotion | {summary.get('eligible_for_promotion', 0)} |\n"
    f"| Overall Trust Index | {summary.get('overall_trust_index', 0):.2f} |\n"
)

# ğŸ§± Markdown-ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
content = f"""# ğŸ” Hybrid Feedback Status

_Last sync: **{timestamp} UTC**_

---

## ğŸ§  Overview

This file is automatically generated by  
`Hybrid Feedback Listener (v1)` â€” pulling lab trust data from Hybrid mock or live orchestrator.

| Field | Description |
|:------|:-------------|
| `trust_score` | Numerical trust index (0â€“1.0) |
| `status` | Lab security validation stage |
| `promotion_ready` | Indicates if lab can move up from sandbox |
| `notes` | Brief remarks from Hybrid feedback pipeline |

---

## ğŸ§© Latest Feedback Snapshot

{table_header}{table}

---

## ğŸ“ˆ Summary

{summary_table}

---

### ğŸ§© Next Update
Synced every **15 minutes** or on manual trigger via  
**Actions â†’ ğŸ” Hybrid Feedback Listener (v1)**

_Last updated automatically by `scripts/pull_hybrid_feedback.py`_
"""

# ğŸ“ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ°
output_path = pathlib.Path("docs/FEEDBACK_STATUS.md")
output_path.write_text(content, encoding="utf-8")

print(f"âœ… Feedback dashboard updated at {output_path}")
