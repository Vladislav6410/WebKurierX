import os
import requests
import datetime
import pathlib
import json
import re

# ğŸ§© ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
endpoint = os.getenv("HYBRID_FEEDBACK_ENDPOINT", "http://localhost:9090/api/v1/hybrid/feedback")
token = os.getenv("HYBRID_TOKEN", "mock-token")
headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}

# ğŸ—‚ ĞŸÑƒÑ‚Ğ¸
docs_path = pathlib.Path("docs/FEEDBACK_STATUS.md")
logs_dir = pathlib.Path("logs")
logs_dir.mkdir(parents=True, exist_ok=True)
log_file = logs_dir / "hybrid_feedback.log"

print(f"ğŸŒ Fetching feedback from Hybrid endpoint: {endpoint}")

# ğŸ›° ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
try:
    response = requests.get(endpoint, headers=headers, timeout=10)
    response.raise_for_status()
    data = response.json()
except Exception as e:
    print(f"âŒ Failed to get feedback: {e}")
    with log_file.open("a", encoding="utf-8") as lf:
        lf.write(f"[{datetime.datetime.utcnow()}] ERROR: {e}\n")
    raise SystemExit(1)

timestamp = datetime.datetime.utcnow().isoformat() + "Z"
labs = data.get("labs", [])
summary = data.get("summary", {})

# ğŸ§  Ğ¡Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ trust_score Ğ¸Ğ· Ğ»Ğ¾Ğ³Ğ¾Ğ²
previous_scores = {}
if log_file.exists():
    try:
        content = log_file.read_text(encoding="utf-8")
        matches = re.findall(r"- (\w+): trust=([0-9.]+)", content)
        for lab, score in matches[-10:]:  # Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
            previous_scores[lab] = float(score)
    except Exception:
        pass

# ğŸ§¾ Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸
with log_file.open("a", encoding="utf-8") as lf:
    lf.write(f"\n[{timestamp}] Feedback sync\n")
    for lab in labs:
        lf.write(
            f"  - {lab.get('name')}: trust={lab.get('trust_score', 0):.2f}, "
            f"status={lab.get('status')}, ready={lab.get('promotion_ready')}\n"
        )
    lf.write(
        f"  Summary: overall_trust={summary.get('overall_trust_index', 0):.2f}, "
        f"eligible={summary.get('eligible_for_promotion', 0)} / "
        f"total={summary.get('total_labs', len(labs))}\n"
    )

print(f"ğŸªµ Log updated â†’ {log_file}")

# ğŸ“Š Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Markdown Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸ĞµĞ¼ trust_score
table_header = "| ğŸ§ª Lab | ğŸ”’ Trust Score | ğŸ“Š Status | ğŸš€ Promotion Ready | ğŸ§­ Change | ğŸ“ Notes |\n"
table_header += "|:------|:---------------:|:----------|:------------------:|:---------:|:---------|\n"

rows = []
for lab in labs:
    name = lab.get("name")
    current_score = lab.get("trust_score", 0)
    prev_score = previous_scores.get(name)
    delta = None
    trend = ""

    if prev_score is not None:
        delta = round(current_score - prev_score, 3)
        if delta < -0.02:
            trend = f"âš ï¸ â†“{abs(delta):.2f}"
        elif delta > 0.02:
            trend = f"ğŸŸ¢ â†‘{delta:.2f}"
        else:
            trend = "â– stable"
    else:
        trend = "ğŸ†• new"

    rows.append(
        f"| {name} "
        f"| {current_score:.2f} "
        f"| {'âœ… validated' if lab.get('status') == 'validated' else 'ğŸ•“ ' + lab.get('status', 'unknown')} "
        f"| {'âœ… yes' if lab.get('promotion_ready') else 'âŒ no'} "
        f"| {trend} "
        f"| {lab.get('notes', '').replace('|', '/')} |"
    )
table = "\n".join(rows)

summary_table = (
    "| Metric | Value |\n"
    "|:--------|:------|\n"
    f"| Total Labs | {summary.get('total_labs', len(labs))} |\n"
    f"| Eligible for Promotion | {summary.get('eligible_for_promotion', 0)} |\n"
    f"| Overall Trust Index | {summary.get('overall_trust_index', 0):.2f} |\n"
)

# ğŸ§± Markdown Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
content = f"""# ğŸ” Hybrid Feedback Status

_Last sync: **{timestamp} UTC**_

---

## ğŸ§  Overview

This file is automatically generated by  
**Hybrid Feedback Listener (Enterprise v2)** â€” with trust trend analysis and promotion readiness.

| Field | Description |
|:------|:-------------|
| `trust_score` | Numerical trust index (0â€“1.0) |
| `status` | Lab validation stage |
| `promotion_ready` | Indicates if lab can move up from sandbox |
| `change` | Trust delta since last sync |
| `notes` | Remarks from Hybrid feedback pipeline |

---

## ğŸ§© Latest Feedback Snapshot

{table_header}{table}

---

## ğŸ“ˆ Summary

{summary_table}

---

### ğŸ§¾ Historical Log Reference
See detailed trust history at:  
`logs/hybrid_feedback.log`

---

### ğŸ§© Next Update
Synced every **15 minutes** or on manual trigger via  
**Actions â†’ ğŸ” Hybrid Feedback Listener (v1)**

_Last updated automatically by `scripts/pull_hybrid_feedback.py`_
"""

docs_path.write_text(content, encoding="utf-8")
print(f"âœ… Markdown dashboard updated with trust delta â†’ {docs_path}")
